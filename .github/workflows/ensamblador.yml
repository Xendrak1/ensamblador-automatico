name: Ensamblador Autom谩tico

on:
  push:
    branches:
      - main  # Se ejecuta autom谩ticamente cuando subes c贸digo a main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Descargar c贸digo desde GitHub
        uses: actions/checkout@v3

      - name: Instalar herramientas necesarias
        run: sudo apt update && sudo apt install -y nasm gdb python3-pandas

      - name: Compilar c贸digo ensamblador
        run: |
          nasm -f elf64 -g -F dwarf programa.asm -o programa.o  # Agregar s铆mbolos de depuraci贸n
          ld -o programa programa.o
          chmod +x programa  # Asegurar permisos de ejecuci贸n

      - name: Verificar que el ejecutable existe
        run: |
          if [ ! -f "programa" ]; then
            echo "ERROR: programa no fue generado";
            exit 1;
          fi

      - name: Ejecutar en GDB y extraer datos
        run: |
          echo "set pagination off" > debug.gdb
          echo "set logging on" >> debug.gdb
          echo "file programa" >> debug.gdb
          echo "start" >> debug.gdb  #  Se cambia "run" por "start"
          echo "info registers" >> debug.gdb
          echo "x/20x $rsp" >> debug.gdb
          echo "quit" >> debug.gdb
          gdb -batch -x debug.gdb > salida_gdb.txt || { echo "ERROR: GDB fall贸"; exit 1; }

      - name: Generar tablas en CSV
        run: |
          python3 scripts/procesar_gdb.py || echo "ERROR: Fall贸 la conversi贸n de datos" && exit 1

      - name: Subir archivos de salida
        uses: actions/upload-artifact@v3
        with:
          name: resultados
          path: |
            output/variables.csv
            output/reserva.csv
            output/registros.csv
