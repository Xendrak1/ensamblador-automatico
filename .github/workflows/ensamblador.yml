name: Ensamblador Automático

on:
  push:
    branches:
      - main  # Se ejecuta cuando subes código a main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Descargar código
        uses: actions/checkout@v3

      - name: Instalar herramientas
        run: sudo apt update && sudo apt install -y nasm gdb python3-pandas

      - name: Compilar ensamblador
        run: |
          nasm -f elf64 programa.asm -o programa.o
          ld programa.o -o programa

      - name: Ejecutar en GDB y extraer datos
        run: |
          echo "set pagination off" > debug.gdb
          echo "set logging on" >> debug.gdb
          echo "target exec ./programa" >> debug.gdb
          echo "break _start" >> debug.gdb
          echo "run" >> debug.gdb
          echo "info variables" >> debug.gdb
          echo "info registers" >> debug.gdb
          echo "x/100x $rsp" >> debug.gdb
          echo "quit" >> debug.gdb
          gdb -batch -x debug.gdb > salida_gdb.txt

      - name: Generar tablas en CSV
        run: python3 scripts/procesar_gdb.py

      - name: Subir archivos de salida
        uses: actions/upload-artifact@v3
        with:
          name: resultados
          path: |
            output/variables.csv
            output/reserva.csv
            output/registros.csv
